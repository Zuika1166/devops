name: Maven CI

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  verify:
    runs-on: ubuntu-latest

    env:
      REPORT_DIR: build-report

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Run Maven verify
        run: mvn -B clean verify -Dcheckstyle.skip=true

      - name: Generate build summary
        if: always()
        run: |
          mkdir -p $REPORT_DIR

          {
            echo "CI SUMMARY"
            echo "Project: $GITHUB_REPOSITORY"
            echo "Branch: $GITHUB_REF_NAME"
            echo "Commit SHA: $GITHUB_SHA"
            echo "Result: ${{ job.status }}"
          } > $REPORT_DIR/summary.txt

      - name: Upload build summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary
          path: ${{ env.REPORT_DIR }}/summary.txt

      - name: Notify via Telegram
        if: always()
        continue-on-error: true
        run: |
          TIME=$(date '+%Y-%m-%d %H:%M:%S')
          RUN_LINK="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          MESSAGE="CI завершён

          Репозиторий: $GITHUB_REPOSITORY
          Ветка: $GITHUB_REF_NAME
          Дата: $TIME
          Статус: ${{ job.status }}

          Подробности:
          $RUN_LINK"

          curl -s \
            -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            --data-urlencode text="$MESSAGE"
